<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>胶片摄影工具箱</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for a nice look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #1a1a2e; transition: background-color 0.2s ease-in-out; }
        .card { background-color: #16213e; }
        .result-card { background-color: #0f3460; }
        .timer-card { background-color: #e0e0e0; color: #16213e; }
        .app-title { color: #e0e0e0; }
        .subtitle { color: #b39ddb; }
        .label, .result-label { color: #e0e0e0; }
        .result-text { color: #ffffff; }
        .input, .select { background-color: #1a1a2e; border-color: #4d4d7a; color: #ffffff; }
        .button { background-color: #0f3460; transition: background-color 0.2s; }
        .button:hover { background-color: #164073; }
        .button-secondary { background-color: #4a4a8a; }
        .button-secondary:hover { background-color: #6a6aac; }
        .button-danger { background-color: #c53030; }
        .button-danger:hover { background-color: #9b2c2c; }
        .error-message { background-color: #e53e3e; color: #ffffff; }
        .flashing { background-color: #f7b733 !important; }
        .tab-button { background-color: #16213e; color: #b39ddb; }
        .tab-button.active { background-color: #0f3460; color: #ffffff; }
        .modal-overlay { background-color: rgba(0,0,0,0.7); z-index: 50; }
    </style>
</head>
<body class="min-h-screen">

<div class="w-full max-w-md mx-auto p-4 pt-8">
    <!-- Header -->
    <!-- UPDATED: Restructured header for robust layout -->
    <header class="mb-4">
        <div class="flex justify-end">
            <button id="lang-switcher" class="bg-gray-700 text-white text-sm font-bold py-1 px-3 rounded-md mb-2"></button>
        </div>
        <div class="text-center">
            <h1 class="text-4xl font-bold app-title" data-lang-key="title"></h1>
            <p class="text-lg subtitle mt-2" data-lang-key="subtitle"></p>
        </div>
    </header>

    <!-- Main Content Area -->
    <div>
        <!-- Tab Navigation -->
        <div class="flex mb-4 rounded-lg overflow-hidden">
            <button id="tab-reciprocity" class="tab-button w-1/2 p-3 font-bold active" data-lang-key="tabReciprocity"></button>
            <button id="tab-hyperfocal" class="tab-button w-1/2 p-3 font-bold" data-lang-key="tabHyperfocal"></button>
        </div>

        <!-- Reciprocity Calculator Panel -->
        <div id="panel-reciprocity">
            <main id="calculator-card" class="card rounded-2xl p-6 transition-opacity duration-300">
                <div class="mb-5"><label for="film-select" class="block mb-2 text-md font-medium label" data-lang-key="labelFilm"></label><select id="film-select" class="select border text-sm rounded-lg block w-full p-2.5"></select></div>
                <div id="delete-film-area" class="hidden mb-5 text-right"><button id="delete-film-btn" class="text-red-400 text-sm hover:text-red-200" data-lang-key="deleteThisFilm"></button></div>
                <div id="custom-factor-group" class="mb-5 hidden"><label for="custom-factor" class="block mb-2 text-md font-medium label" data-lang-key="labelCustomFactor"></label><div class="flex space-x-2"><input type="number" id="custom-factor" class="input border text-sm rounded-lg block w-full p-2.5" data-lang-placeholder="placeholderPValue"><button id="save-custom-btn" class="button-secondary text-white rounded-lg px-4" data-lang-key="btnSave"></button></div></div>
                <div class="mb-5"><label for="nd-filter-select" class="block mb-2 text-md font-medium label" data-lang-key="labelND"></label><select id="nd-filter-select" class="select border text-sm rounded-lg block w-full p-2.5"></select></div>
                <div class="mb-5"><label class="block mb-2 text-md font-medium label" data-lang-key="labelBellows"></label><div class="flex items-center space-x-2"><input type="number" id="focal-length" class="input border text-sm rounded-lg block w-full p-2.5 text-center" data-lang-placeholder="placeholderFocalLength"><span class="text-white text-lg">mm</span><input type="number" id="bellows-extension" class="input border text-sm rounded-lg block w-full p-2.5 text-center" data-lang-placeholder="placeholderBellows"><span class="text-white text-lg">mm</span></div></div>
                <div class="mb-5"><label class="block mb-2 text-md font-medium label" data-lang-key="labelMeteredTime"></label><div class="flex items-center space-x-2"><input type="number" id="metered-time-min" class="input border text-sm rounded-lg block w-full p-2.5 text-center" placeholder="0"><span class="text-white text-lg" data-lang-key="unitMin"></span><input type="number" id="metered-time-sec" class="input border text-sm rounded-lg block w-full p-2.5 text-center" placeholder="30"><span class="text-white text-lg" data-lang-key="unitSec"></span></div></div>
                <button id="calculate-btn" class="button text-white w-full font-bold rounded-lg text-lg px-5 py-3 text-center" data-lang-key="btnCalculate"></button>
            </main>
            <div id="message-area" class="mt-6"></div>
        </div>

        <!-- Hyperfocal Calculator Panel -->
        <div id="panel-hyperfocal" class="hidden">
            <main class="card rounded-2xl p-6">
                <div class="mb-5"><label for="hf-format" class="block mb-2 text-md font-medium label" data-lang-key="labelFormat"></label><select id="hf-format" class="select border text-sm rounded-lg block w-full p-2.5"></select></div>
                <div class="mb-5"><label for="hf-focal-length" class="block mb-2 text-md font-medium label" data-lang-key="labelHfFocalLength"></label><input type="number" id="hf-focal-length" class="input border text-sm rounded-lg block w-full p-2.5" data-lang-placeholder="placeholderHfFocalLength"></div>
                <div class="mb-5"><label for="hf-aperture" class="block mb-2 text-md font-medium label" data-lang-key="labelHfAperture"></label><input type="number" id="hf-aperture" class="input border text-sm rounded-lg block w-full p-2.5" data-lang-placeholder="placeholderHfAperture"></div>
                <button id="calculate-hf-btn" class="button text-white w-full font-bold rounded-lg text-lg px-5 py-3 text-center" data-lang-key="btnCalculateHf"></button>
            </main>
            <div id="hf-message-area" class="mt-6"></div>
        </div>
    </div>

    <!-- Shared Modals & Timer -->
    <div id="timer-card" class="hidden text-center p-6 rounded-2xl timer-card"><h2 id="timer-display" class="text-6xl font-bold mb-6">00:00</h2><button id="stop-timer-btn" class="button-secondary text-white w-full font-bold rounded-lg text-lg px-5 py-3 text-center" data-lang-key="btnStopTimer"></button></div>
    <div id="save-modal" class="hidden fixed inset-0 modal-overlay flex items-center justify-center p-4"><div class="card rounded-2xl p-6 w-full max-w-sm"><h3 class="text-xl font-bold text-white mb-4" data-lang-key="modalSaveTitle"></h3><label for="custom-film-name" class="block mb-2 text-md font-medium label" data-lang-key="modalSaveLabel"></label><input type="text" id="custom-film-name" class="input border text-sm rounded-lg block w-full p-2.5" data-lang-placeholder="modalSavePlaceholder"><div class="flex justify-end space-x-4 mt-6"><button id="cancel-save-btn" class="button-secondary text-white font-bold rounded-lg px-5 py-2" data-lang-key="btnCancel"></button><button id="confirm-save-btn" class="button text-white font-bold rounded-lg px-5 py-2" data-lang-key="btnConfirmSave"></button></div></div></div>
    <div id="delete-modal" class="hidden fixed inset-0 modal-overlay flex items-center justify-center p-4"><div class="card rounded-2xl p-6 w-full max-w-sm"><h3 class="text-xl font-bold text-white mb-4" data-lang-key="modalDeleteTitle"></h3><p id="delete-confirm-text" class="text-white mb-6"></p><div class="flex justify-end space-x-4"><button id="cancel-delete-btn" class="button-secondary text-white font-bold rounded-lg px-5 py-2" data-lang-key="btnCancel"></button><button id="confirm-delete-btn" class="button-danger text-white font-bold rounded-lg px-5 py-2" data-lang-key="btnConfirmDelete"></button></div></div></div>
</div>

<script>
    // --- TRANSLATION OBJECT ---
    const translations = {
        en: {
            title: "Film Photography Toolkit", subtitle: "Precise calculation for your creation", langSwitch: "中", tabReciprocity: "Reciprocity", tabHyperfocal: "Hyperfocal",
            labelFilm: "1. Select Film", customFilmOption: "Custom Film...", deleteThisFilm: "Delete this film", labelCustomFactor: "Custom Reciprocity Factor (p)", btnSave: "Save",
            labelND: "2. Select ND Filter (Optional)", labelBellows: "3. Bellows Comp. (Optional)", placeholderFocalLength: "Focal L.", placeholderBellows: "Bellows Ext.",
            labelMeteredTime: "4. Metered Time", unitMin: "min", unitSec: "sec", btnCalculate: "Calculate Exposure",
            labelFormat: "1. Select Format", labelHfFocalLength: "2. Focal Length (mm)", placeholderHfFocalLength: "e.g., 50", labelHfAperture: "3. Aperture (f/)", placeholderHfAperture: "e.g., 8",
            btnCalculateHf: "Calculate Hyperfocal", btnStartTimer: "Start Timer", btnStopTimer: "Stop Timer",
            modalSaveTitle: "Save Custom Film", modalSaveLabel: "Film Name", modalSavePlaceholder: "e.g., My HP5+", btnCancel: "Cancel", btnConfirmSave: "Confirm & Save",
            modalDeleteTitle: "Confirm Deletion", modalDeleteText: "Are you sure you want to delete '{filmName}'? This action cannot be undone.", btnConfirmDelete: "Confirm Delete",
            errorInvalidTime: { title: "Invalid Input", content: "Please enter a valid time greater than 0." },
            errorInvalidName: { title: "Invalid Name", content: "Please enter a name for the film." },
            errorInvalidFactor: { title: "Invalid Factor", content: "Please enter a reciprocity factor (p-value) greater than 1." },
            errorNoFilm: { title: "Error", content: "Selected film not found." },
            errorOutOfRange: { title: "Out of Range", content: "Official data for this exposure time is unknown. Please consult the datasheet or test it." },
            errorInvalidHf: { title: "Invalid Input", content: "Please enter all valid values for focal length and aperture." },
            resultCorrectedTime: "Corrected Exposure", resultHyperfocal: "Hyperfocal Distance",
            unitMeter: "meters", timeUnitSec: "sec", timeUnitMin: "min", timerComplete: "Done!"
        },
        zh: {
            title: "胶片摄影工具箱", subtitle: "精准计算，轻松创作", langSwitch: "EN", tabReciprocity: "倒易律", tabHyperfocal: "超焦距",
            labelFilm: "1. 选择胶片", customFilmOption: "自定义胶片...", deleteThisFilm: "删除此胶片", labelCustomFactor: "自定义倒易律系数 (p)", btnSave: "保存",
            labelND: "2. 选择 ND 减光镜 (可选)", labelBellows: "3. 大画幅皮腔补偿 (可选)", placeholderFocalLength: "镜头焦距", placeholderBellows: "皮腔长度",
            labelMeteredTime: "4. 输入相机测光时间", unitMin: "分", unitSec: "秒", btnCalculate: "计算曝光时间",
            labelFormat: "1. 选择画幅", labelHfFocalLength: "2. 输入焦距 (mm)", placeholderHfFocalLength: "例如: 50", labelHfAperture: "3. 输入光圈 (f/)", placeholderHfAperture: "例如: 8",
            btnCalculateHf: "计算超焦距", btnStartTimer: "开始计时", btnStopTimer: "停止计时",
            modalSaveTitle: "保存自定义胶片", modalSaveLabel: "胶片名称", modalSavePlaceholder: "例如: 我的HP5+", btnCancel: "取消", btnConfirmSave: "确认保存",
            modalDeleteTitle: "确认删除", modalDeleteText: "您确定要删除胶片 “{filmName}” 吗？此操作无法撤销。", btnConfirmDelete: "确认删除",
            errorInvalidTime: { title: "输入无效", content: "请输入一个大于0的有效时间。" },
            errorInvalidName: { title: "名称无效", content: "请输入胶片名称。" },
            errorInvalidFactor: { title: "系数无效", content: "请输入一个大于1的倒易律系数 (p 值)。" },
            errorNoFilm: { title: "错误", content: "未找到所选胶片。" },
            errorOutOfRange: { title: "超出范围", content: "该胶片对于此曝光时间的官方数据未知，请查阅数据手册或进行测试。" },
            errorInvalidHf: { title: "输入无效", content: "请填写所有有效的焦距和光圈值。" },
            resultCorrectedTime: "校正后曝光时间", resultHyperfocal: "超焦距",
            unitMeter: "米", timeUnitSec: "秒", timeUnitMin: "分", timerComplete: "完成!"
        }
    };

    // --- DATA & CONFIG ---
    const ndFilters = [ { name: '无', factor: 1 }, { name: 'ND4 (2档)', factor: 4 }, { name: 'ND8 (3档)', factor: 8 }, { name: 'ND64 (6档)', factor: 64 }, { name: 'ND1000 (10档)', factor: 1024 }, { name: 'ND100K (16.6档)', factor: 100000 } ];
    const sensorFormats = [ { name: '全画幅 (35mm)', coc: 0.030 }, { name: 'APS-C', coc: 0.020 }, { name: 'M4/3', coc: 0.015 }, { name: '6x6 中画幅', coc: 0.060 }, { name: '4x5 大画幅', coc: 0.100 } ];
    const calculatePortra = (tm) => { if (tm <= 1) return tm * 2; if (tm <= 10) return 2 + (tm - 1) * (28 / 9); if (tm <= 100) return 30 + (tm - 10) * (170 / 90); return -1; };
    const baseFilmData = [
      { id: 'cinestill_800t', name: 'CineStill 800T', p: 0, calculate: (tm) => tm > 1 ? tm * 2.6 : tm },
      { id: 'fomapan_100', name: 'Foma PAN 100', p: 0, calculate: (tm) => 0.89 * Math.pow(tm, 1.83) },
      { id: 'fomapan_400', name: 'Foma PAN 400', p: 0, calculate: (tm) => 1.30 * Math.pow(tm, 1.90) },
      { id: 'fujifilm_provia_100f', name: 'Fujifilm Provia 100F', p: 0, calculate: (tm) => (tm <= 128) ? tm : -1 },
      { id: 'fujifilm_velvia_50', name: 'Fujifilm Velvia 50', p: 0, calculate: (tm) => { if (tm <= 2) return tm; if (tm <= 4) return 8; if (tm <= 8) return 20; if (tm <= 15) return 50; if (tm <= 30) return 150; if (tm <= 60) return 300; return -1; } },
      { id: 'ilford_delta_100', name: 'Ilford Delta 100', p: 1.31 }, { id: 'ilford_delta_400', name: 'Ilford Delta 400', p: 1.29 }, { id: 'ilford_delta_3200', name: 'Ilford Delta 3200', p: 1.34 }, { id: 'ilford_hp5_plus', name: 'Ilford HP5+', p: 1.31 },
      { id: 'kentmere_pan_100', name: 'Kentmere PAN 100', p: 1.35 }, { id: 'kentmere_pan_400', name: 'Kentmere PAN 400', p: 1.38 },
      { id: 'kodak_ektar_100', name: 'Kodak Ektar 100', p: 0, calculate: (tm) => tm * 1.5 },
      { id: 'kodak_portra_160', name: 'Kodak Portra 160', p: 0, calculate: calculatePortra }, { id: 'kodak_portra_400', name: 'Kodak Portra 400', p: 0, calculate: calculatePortra }, { id: 'kodak_portra_800', name: 'Kodak Portra 800', p: 0, calculate: calculatePortra },
      { id: 'kodak_vision3_250d', name: 'Kodak Vision3 250D (5207)', p: 0, calculate: (tm) => (tm <= 10) ? tm * 1.5 : -1 },
      { id: 'kodak_vision3_500t', name: 'Kodak Vision3 500T (5219)', p: 0, calculate: (tm) => (tm <= 10) ? tm * 1.5 : -1 },
      { id: 'custom', name: '自定义胶片...', p: 0 }
    ];
    let currentLanguage = 'zh';

    // --- DOM Elements ---
    const dom = {
        langSwitcher: document.getElementById('lang-switcher'),
        tabs: { reciprocity: document.getElementById('tab-reciprocity'), hyperfocal: document.getElementById('tab-hyperfocal') },
        panels: { reciprocity: document.getElementById('panel-reciprocity'), hyperfocal: document.getElementById('panel-hyperfocal') },
        reciprocity: { filmSelect: document.getElementById('film-select'), deleteArea: document.getElementById('delete-film-area'), deleteBtn: document.getElementById('delete-film-btn'), customGroup: document.getElementById('custom-factor-group'), customInput: document.getElementById('custom-factor'), saveBtn: document.getElementById('save-custom-btn'), ndSelect: document.getElementById('nd-filter-select'), minInput: document.getElementById('metered-time-min'), secInput: document.getElementById('metered-time-sec'), calculateBtn: document.getElementById('calculate-btn'), messageArea: document.getElementById('message-area'), focalLengthInput: document.getElementById('focal-length'), bellowsExtensionInput: document.getElementById('bellows-extension') },
        hyperfocal: { format: document.getElementById('hf-format'), focalLength: document.getElementById('hf-focal-length'), aperture: document.getElementById('hf-aperture'), calculateBtn: document.getElementById('calculate-hf-btn'), messageArea: document.getElementById('hf-message-area') },
        timer: { card: document.getElementById('timer-card'), display: document.getElementById('timer-display'), stopBtn: document.getElementById('stop-timer-btn') },
        modals: { save: document.getElementById('save-modal'), saveNameInput: document.getElementById('custom-film-name'), cancelSave: document.getElementById('cancel-save-btn'), confirmSave: document.getElementById('confirm-save-btn'), delete: document.getElementById('delete-modal'), deleteText: document.getElementById('delete-confirm-text'), cancelDelete: document.getElementById('cancel-delete-btn'), confirmDelete: document.getElementById('confirm-delete-btn') }
    };

    let timerInterval, alarmInterval, audioCtx, tempPValue = 0, filmToDelete = null;

    const setLanguage = (lang) => {
        currentLanguage = lang; localStorage.setItem('language', lang); document.documentElement.lang = lang; const langData = translations[lang];
        document.querySelectorAll('[data-lang-key]').forEach(el => { el.textContent = langData[el.dataset.langKey]; });
        document.querySelectorAll('[data-lang-placeholder]').forEach(el => { el.placeholder = langData[el.dataset.langPlaceholder]; });
        dom.langSwitcher.textContent = langData.langSwitch; populateFilmSelect(); populateNdSelect(); populateFormatSelect();
    };

    const formatTime = (s, units=true) => { const t=Math.round(s); const langData=translations[currentLanguage]; if(s<0||s===null)return"N/A";if(!units){const m=String(Math.floor(t/60)).padStart(2,'0');const sec=String(t%60).padStart(2,'0');return`${m}:${sec}`}if(t<60)return`${t.toFixed(0)} ${langData.timeUnitSec}`;const m=Math.floor(t/60);const sec=t%60;return`${m} ${langData.timeUnitMin} ${sec.toFixed(0)} ${langData.timeUnitSec}`};
    const showMessage = (area, type, titleKey, contentKey, finalTime) => {
        let cardHtml = ''; const langData = translations[currentLanguage]; let title, content;
        if (typeof langData[titleKey] === 'object' && langData[titleKey] !== null) { title = langData[titleKey].title; content = langData[titleKey].content; } else { title = langData[titleKey]; content = contentKey; }
        if(type==='result'&&area===dom.reciprocity.messageArea){cardHtml=`<div class="result-card rounded-2xl p-5 text-center"><p class="text-lg result-label">${title}</p><p class="text-4xl font-bold result-text mb-4">${content}</p><button id="start-timer-btn" data-time="${finalTime}" class="button text-white w-full font-bold rounded-lg text-lg px-5 py-3 text-center">${langData.btnStartTimer}</button></div>`}
        else if(type==='result'){cardHtml=`<div class="result-card rounded-2xl p-5 text-center"><p class="text-lg result-label">${title}</p><p class="text-3xl font-bold result-text">${content}</p></div>`}
        else{cardHtml=`<div class="error-message rounded-lg p-4 text-center"><p class="font-bold">${title}</p><p>${content}</p></div>`}
        area.innerHTML = cardHtml; if(type==='result'&&area===dom.reciprocity.messageArea){document.getElementById('start-timer-btn').addEventListener('click',e=>startTimer(parseFloat(e.target.dataset.time)))}};

    const handleReciprocityCalculate = () => {
        const minutes = parseFloat(dom.reciprocity.minInput.value) || 0; const seconds = parseFloat(dom.reciprocity.secInput.value) || 0; const baseTime = (minutes * 60) + seconds; if (baseTime <= 0) { showMessage(dom.reciprocity.messageArea, 'error', 'errorInvalidTime'); return; }
        const ndFactor = parseFloat(dom.reciprocity.ndSelect.value); const focalLength = parseFloat(dom.reciprocity.focalLengthInput.value) || 0; const bellowsExtension = parseFloat(dom.reciprocity.bellowsExtensionInput.value) || 0; let bellowsFactor = 1; if (focalLength > 0 && bellowsExtension > focalLength) { bellowsFactor = (bellowsExtension / focalLength) ** 2; }
        const timeBeforeReciprocity = baseTime * ndFactor * bellowsFactor; const selectedFilmId = dom.reciprocity.filmSelect.value; let tc; const filmData = [...baseFilmData, ...JSON.parse(localStorage.getItem('customFilms') || '[]')]; const film = filmData.find((f) => f.id === selectedFilmId); if (!film) { showMessage(dom.reciprocity.messageArea, 'error', 'errorNoFilm'); return; };
        if (selectedFilmId === 'custom') { const p = parseFloat(dom.reciprocity.customInput.value); if (isNaN(p) || p <= 1.0) { showMessage(dom.reciprocity.messageArea, 'error', 'errorInvalidFactor'); return; } tc = timeBeforeReciprocity > 1 ? Math.pow(timeBeforeReciprocity, p) : timeBeforeReciprocity; }
        else if (film.calculate) { tc = film.calculate(timeBeforeReciprocity); } else { tc = timeBeforeReciprocity > 1 ? Math.pow(timeBeforeReciprocity, film.p) : timeBeforeReciprocity; }
        if (tc === -1) { showMessage(dom.reciprocity.messageArea, 'error', 'errorOutOfRange'); } else { showMessage(dom.reciprocity.messageArea, 'result', 'resultCorrectedTime', formatTime(tc), tc); }
    };

    const handleHyperfocalCalculate = () => { const fl=parseFloat(dom.hyperfocal.focalLength.value);const ap=parseFloat(dom.hyperfocal.aperture.value);const coc=parseFloat(dom.hyperfocal.format.value);if(!fl||!ap||!coc||fl<=0||ap<=0){showMessage(dom.hyperfocal.messageArea,'error','errorInvalidHf');return}const hfMM=(fl*fl)/(ap*coc)+fl;const hfM=(hfMM/1000).toFixed(2);showMessage(dom.hyperfocal.messageArea,'result','resultHyperfocal',`${hfM} ${translations[currentLanguage].unitMeter}`)};

    const populateFilmSelect = () => {
        const customFilms = JSON.parse(localStorage.getItem('customFilms') || '[]');
        const allFilms = [...baseFilmData, ...customFilms];

        const currentVal = dom.reciprocity.filmSelect.value;
        dom.reciprocity.filmSelect.innerHTML = '';

        const customTemplate = allFilms.find(f => f.id === 'custom');
        const sortedFilms = allFilms.filter(f => f.id !== 'custom').sort((a,b) => a.name.localeCompare(b.name, currentLanguage === 'zh' ? 'zh-Hans-CN' : 'en-US'));

        [...sortedFilms, customTemplate].forEach(film => {
            if(!film) return;
            const option = document.createElement('option');
            option.value = film.id;
            option.textContent = film.id === "custom" ? translations[currentLanguage].customFilmOption : film.name;
            dom.reciprocity.filmSelect.appendChild(option);
        });

        if (document.querySelector(`#film-select option[value="${currentVal}"]`)) {
            dom.reciprocity.filmSelect.value = currentVal;
        } else {
            dom.reciprocity.filmSelect.value = 'custom';
        }
        handleFilmSelectChange();
    };
    const populateNdSelect = () => { dom.reciprocity.ndSelect.innerHTML = ''; ndFilters.forEach(f => { const opt = document.createElement('option'); opt.value = f.factor; opt.textContent = f.name; dom.reciprocity.ndSelect.appendChild(opt); }); };
    const populateFormatSelect = () => { dom.hyperfocal.format.innerHTML = ''; sensorFormats.forEach(f => { const opt = document.createElement('option'); opt.value = f.coc; opt.textContent = f.name; dom.hyperfocal.format.appendChild(opt); }); };
    const handleFilmSelectChange = () => { dom.reciprocity.messageArea.innerHTML = ''; const isCustom = dom.reciprocity.filmSelect.value === 'custom'; const isSavedCustom = dom.reciprocity.filmSelect.value.startsWith('custom_'); dom.reciprocity.customGroup.classList.toggle('hidden', !isCustom); dom.reciprocity.deleteArea.classList.toggle('hidden', !isSavedCustom); };
    const openSaveModal = () => { tempPValue = parseFloat(dom.reciprocity.customInput.value); if (isNaN(tempPValue) || tempPValue <= 1.0) { showMessage(dom.reciprocity.messageArea, 'error', 'errorInvalidFactor'); return; } dom.modals.saveNameInput.value = ''; dom.modals.save.classList.remove('hidden'); dom.modals.saveNameInput.focus(); };
    const closeSaveModal = () => { dom.modals.save.classList.add('hidden'); };
    const confirmSaveCustomFilm = () => { const name = dom.modals.saveNameInput.value.trim(); if (!name) { showMessage(dom.reciprocity.messageArea, 'error', 'errorInvalidName'); return; } const customFilms = JSON.parse(localStorage.getItem('customFilms') || '[]'); const newFilm = { id: `custom_${Date.now()}`, name: name, p: tempPValue }; customFilms.push(newFilm); localStorage.setItem('customFilms', JSON.stringify(customFilms)); populateFilmSelect(); dom.reciprocity.filmSelect.value = newFilm.id; handleFilmSelectChange(); closeSaveModal(); };
    const openDeleteModal = () => { const selectedOption = dom.reciprocity.filmSelect.options[dom.reciprocity.filmSelect.selectedIndex]; filmToDelete = { id: selectedOption.value, name: selectedOption.text }; dom.modals.deleteText.textContent = translations[currentLanguage].modalDeleteText.replace('{filmName}', filmToDelete.name); dom.modals.delete.classList.remove('hidden'); };
    const closeDeleteModal = () => { dom.modals.delete.classList.add('hidden'); filmToDelete = null; };
    const confirmDeleteFilm = () => { if (!filmToDelete) return; let customFilms = JSON.parse(localStorage.getItem('customFilms') || '[]'); customFilms = customFilms.filter(f => f.id !== filmToDelete.id); localStorage.setItem('customFilms', JSON.stringify(customFilms)); populateFilmSelect(); closeDeleteModal(); };
    const playBeep = () => { if (!audioCtx) audioCtx = new(window.AudioContext || window.webkitAudioContext)(); const osc = audioCtx.createOscillator(); osc.type = 'sine'; osc.frequency.setValueAtTime(880, audioCtx.currentTime); osc.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 0.2); };
    const stopTimer = () => { clearInterval(timerInterval); clearInterval(alarmInterval); timerInterval = alarmInterval = null; document.body.classList.remove('flashing'); dom.panels.reciprocity.classList.remove('hidden'); dom.panels.hyperfocal.classList.add('hidden'); dom.tabs.reciprocity.click(); dom.timer.card.classList.add('hidden'); };
    const startTimer = (totalSeconds) => { dom.panels.reciprocity.classList.add('hidden'); dom.panels.hyperfocal.classList.add('hidden'); dom.timer.card.classList.remove('hidden'); let remaining = Math.round(totalSeconds); dom.timer.display.textContent = formatTime(remaining, false); timerInterval = setInterval(() => { remaining--; dom.timer.display.textContent = formatTime(remaining, false); if (remaining <= 0) { clearInterval(timerInterval); dom.timer.display.textContent = translations[currentLanguage].timerComplete; alarmInterval = setInterval(() => { playBeep(); document.body.classList.toggle('flashing'); }, 1000); } }, 1000); };

    const init = () => {
        setLanguage(localStorage.getItem('language') || 'zh');
        dom.langSwitcher.addEventListener('click', () => { setLanguage(currentLanguage === 'zh' ? 'en' : 'zh'); });
        dom.reciprocity.calculateBtn.addEventListener('click', handleReciprocityCalculate); dom.hyperfocal.calculateBtn.addEventListener('click', handleHyperfocalCalculate);
        dom.reciprocity.saveBtn.addEventListener('click', openSaveModal); dom.modals.cancelSave.addEventListener('click', closeSaveModal); dom.modals.confirmSave.addEventListener('click', confirmSaveCustomFilm);
        dom.reciprocity.deleteBtn.addEventListener('click', openDeleteModal); dom.modals.cancelDelete.addEventListener('click', closeDeleteModal); dom.modals.confirmDelete.addEventListener('click', confirmDeleteFilm);
        dom.timer.stopBtn.addEventListener('click', stopTimer);
        dom.tabs.reciprocity.addEventListener('click', () => { dom.tabs.reciprocity.classList.add('active'); dom.tabs.hyperfocal.classList.remove('active'); dom.panels.reciprocity.classList.remove('hidden'); dom.panels.hyperfocal.classList.add('hidden'); });
        dom.tabs.hyperfocal.addEventListener('click', () => { dom.tabs.hyperfocal.classList.add('active'); dom.tabs.reciprocity.classList.remove('active'); dom.panels.hyperfocal.classList.remove('hidden'); dom.panels.reciprocity.classList.add('hidden'); });
        dom.reciprocity.filmSelect.addEventListener('change', handleFilmSelectChange);
        const clearReciprocity = () => dom.reciprocity.messageArea.innerHTML = ''; [dom.reciprocity.minInput, dom.reciprocity.secInput, dom.reciprocity.customInput, dom.reciprocity.ndSelect, dom.reciprocity.focalLengthInput, dom.reciprocity.bellowsExtensionInput].forEach(el => el.addEventListener('input', clearReciprocity));
        const clearHyperfocal = () => dom.hyperfocal.messageArea.innerHTML = ''; [dom.hyperfocal.format, dom.hyperfocal.focalLength, dom.hyperfocal.aperture].forEach(el => el.addEventListener('input', clearHyperfocal));
    };
    init();
</script>
</body>
</html>
